<?xml version="1.0" encoding="utf-8"?>
<odoo>
  
    <!-- Replace image URL in the kanban view -->
    <record id="rating_rating_view_kanban" model="ir.ui.view">
        <field name="model">rating.rating</field>
        <field name="inherit_id" ref="rating.rating_rating_view_kanban"/>
        <field name="arch" type="xml">
            <xpath expr="//img" position="attributes">
                <attribute name="t-attf-src">/rating_project_issue_nps/static/src/img/rate_with_icon_#{record.rating.raw_value}.png</attribute>
            </xpath>
        </field>
    </record>

    <!-- Replace existing filters by "Promoters", "Passives", "Detractors" -->
    <record id="rating_rating_view_search" model="ir.ui.view">
        <field name="model">rating.rating</field>
        <field name="inherit_id" ref="rating.rating_rating_view_search"/>
        <field name="arch" type="xml">
            <xpath expr="//filter[@name='rating_happy']" position="replace">
                <filter string="Promoters" name="rating_promoters" domain="[('rating', 'in', [9, 10])]"/>
            </xpath>
            <xpath expr="//filter[@name='rating_okay']" position="replace">
                <filter string="Passives" name="rating_passives" domain="[('rating', 'in', [8, 7])]"/>
            </xpath>
            <xpath expr="//filter[@name='rating_unhappy']" position="replace">
                <filter string="Detractors" name="rating_detractors" domain="[('rating', '&lt;=', 6)]"/>
            </xpath> 
        </field>
    </record>

    <!-- Replace happy ratings display on project dashboard by NPS -->
    <record id="view_project_kanban" model="ir.ui.view">
        <field name="model">project.project</field>
        <field name="inherit_id" ref="project.view_project_kanban"/>
        <field name="arch" type="xml">
            <field name="partner_id" position="after">
                <field name="net_promoter_score" invisible="1"/>
            </field>
            <xpath expr="//div[@class='o_kanban_primary_left']/div[3]" position="replace">
              <div t-if="record.rating_status.raw_value != 'no'" class="mt8 text-primary"
                   title="Net promoter score over the past 30 days. Get rating details from the More menu.">
                <b>
                  <span t-if="record.net_promoter_score == False" class="rating-no-nps">No NPS</span>
                  <span class="rating-nps" t-else="">
                    <t t-set="nps_names" t-value="['detractor', 'passive', 'promoter']"/>
                    <t t-set="nps_index" t-value="1 + Math.sign(record.net_promoter_score.raw_value)"/>
                    <t t-debug=""/>
                    <img t-attf-src="rating_project_issue_nps/static/src/img/{{ nps_names[nps_index] }}.png" t-att-alt="record.net_promoter_score.value" style="width: 32px;"/>
                    <t t-esc="record.net_promoter_score.raw_value"/>
                    <t t-esc="nps_name"/>
                  </span>
                </b>
              </div>
            </xpath>
        </field>
    </record>

</odoo>
