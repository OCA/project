<?xml version="1.0" encoding="utf-8"?>
<!--
    Copyright (C) 2014 Akretion (http://www.akretion.com/)
    @author: Alexis de Lattre <alexis.delattre@akretion.com>
    The licence is in the file __openerp__.py
-->

<openerp>
<data>

<record id="project_action_item_form" model="ir.ui.view">
    <field name="name">project_action_item.form</field>
    <field name="model">project.action.item</field>
    <field name="arch" type="xml">
        <form string="Action Item" version="7.0">
            <header>
                <button name="%(project_action_item_timesheet_action)d"
                    type="action" string="Mark as Done with Timesheet"
                    class="oe_highlight" states="todo,progress"
                    context="{'action_item_completed': True}"/>
                <button name="%(project_action_item_timesheet_action)d"
                    type="action" string="Mark as Progress with Timesheet"
                    class="oe_highlight" states="todo,progress"
                    context="{'action_item_completed': False}" />
                <button name="set_to_progress" type="object"
                    string="Mark as In Progress" states="todo"/>
                <button name="set_to_done" type="object"
                    string="Mark as Done" states="todo,progress"/>
                <button name="back_to_todo" type="object"
                    string="Back to To Do" states="done,progress"/>
                <field name="state" widget="statusbar"/>
            </header>
            <group name="main">
                <field name="project_id"
                    invisible="not context.get('project_action_item_main_view')"/>
                <field name="task_id"
                    invisible="not context.get('project_action_item_main_view')"/>
                <field name="name" widget="text"/>
                <field name="date_deadline"/>
                <field name="date_done" states="done"/>
                <field name="estimated_hours" widget="float_time"/>
                <field name="timesheet_hours" widget="float_time"/>
                <field name="user_id"/>
                <field name="to_invoice"/>
                <field name="create_date"/>
                <field name="create_uid"/>
                <field name="sequence" invisible="1"/>
            </group>
            <group main="timesheet" string="Timesheets">
                <field name="timesheet_ids" nolabel="1"/>
            </group>
        </form>
    </field>
</record>

<record id="project_action_item_tree" model="ir.ui.view">
    <field name="name">project_action_item.tree</field>
    <field name="model">project.action.item</field>
    <field name="arch" type="xml">
        <tree string="Action Items" editable="bottom" colors="blue:state=='todo';grey:state=='progress'">
            <field name="name"/>
            <field name="project_id"
                invisible="not context.get('project_action_item_main_view')"/>
            <field name="task_id"
                invisible="not context.get('project_action_item_main_view')"/>
            <field name="date_deadline"/>
            <field name="user_id"/>
            <field name="estimated_hours"
                widget="float_time" sum="Total Estimated Hours"/>
            <field name="timesheet_hours"
                widget="float_time" sum="Total Estimated Hours"/>
            <field name="to_invoice"/>
            <button name="%(project_action_item_timesheet_action)d"
                type="action" string="Progress" states="todo,progress"
                icon="gtk-go-forward"
                context="{'action_item_completed': False}"/>
            <button name="action_item_done_with_timesheet_wizard"
                type="object" icon="terp-gtk-jump-to-ltr" string="Done"
                states="todo,progress"/>
            <field name="state"/>
            <field name="sequence" invisible="1"/>
        </tree>
    </field>
</record>

<record id="project_action_item_search" model="ir.ui.view">
    <field name="name">project_action_item.search</field>
    <field name="model">project.action.item</field>
    <field name="arch" type="xml">
        <search string="Search Action Items">
            <field name="name" />
            <filter name="my_action_items_to_work"
                string="My Action Items To Work On"
                domain="[('user_id', '=', uid), ('state', 'in', ('todo', 'progress'))]"/>
            <filter name="my_action_items" string="My Action Items"
                domain="[('user_id', '=', uid)]"/>
            <filter name="to_work" string="To Work On"
                domain="[('state', 'in', ('todo', 'progress'))]" />
            <filter name="done" string="Done"
                domain="[('state', '=', 'done')]" />
            <group string="Group By..." name="groupby">
                <filter name="user_id_groupby" string="User"
                    context="{'group_by': 'user_id'}"/>
                <filter name="task_groupby" string="Task"
                    context="{'group_by': 'task_id'}"/>
            </group>
        </search>
    </field>
</record>

<record id="project_action_item_action" model="ir.actions.act_window">
    <field name="name">Action Items</field>
    <field name="res_model">project.action.item</field>
    <field name="view_type">form</field>
    <field name="view_mode">tree,form</field>
    <field name="context">{'project_action_item_main_view': True, 'search_default_my_action_items_to_work': 1}</field>
</record>


<menuitem id="project_action_item_menu" action="project_action_item_action"
    parent="project.menu_project_management" sequence="11"/>

<!-- add todo action items on tasks -->
<record id="view_task_form2" model="ir.ui.view">
    <field name="name">add.action.items.on.tasks.form</field>
    <field name="model">project.task</field>
    <field name="inherit_id" ref="project.view_task_form2"/>
    <field name="arch" type="xml">
        <field name="work_ids" position="before">
            <group name="to_work_action_items" string="Action Items To Work On">
                <field name="to_work_action_item_ids" nolabel="1"/>
            </group>
            <separator string="Timesheets" />
        </field>
    </field>
</record>

<!-- add link to action item on timesheet -->
<record id="hr_timesheet_line_form" model="ir.ui.view">
    <field name="name">add.action.items.on.timesheet.form</field>
    <field name="model">hr.analytic.timesheet</field>
    <field name="inherit_id" ref="hr_timesheet_task.hr_timesheet_line_form"/>
    <field name="arch" type="xml">
        <field name="task_id" position="after">
            <field name="action_item_id"/>
        </field>
    </field>
</record>

</data>
</openerp>
